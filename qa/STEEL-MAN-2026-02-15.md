# Steel Man Test Report

**Project:** Neuro Plans (iOS App)
**Date:** 2026-02-15
**Tester:** Claude Code (Steel Man Testing Skill)
**Product Type:** iOS App (SwiftUI, iOS 17+)
**Live URL:** Submitted to App Store — Waiting for Review
**Repo:** neuro-plans (local, main branch)
**Branch/Commit:** `main` @ `23c9c27` (Add App Store metadata draft for submission)

---

## Executive Summary

Neuro Plans is a well-crafted neurology clinical reference app with a clean architecture, zero crashes in testing, and genuinely unique value in its venue-specific treatment plan format. However, **the app has significant security and reliability gaps that undermine its readiness for production use by clinicians.** The strongest argument against shipping: two `fatalError()` calls can crash the app with no recovery, the entire trial/entitlement system is stored in unprotected UserDefaults (trivially bypassable), zero accessibility support excludes users with disabilities, zero test coverage means any change risks regressions, and the 10 MB JSON file loaded entirely into memory on launch will cause problems on older devices as content grows. Additionally, the app enters a competitive landscape where MDCalc (free, 4.9 stars, 900+ calculators) and Medscape (free, drug interactions, CME credits) already cover many of the same features at no cost.

**Overall Readiness:** Ready with Caveats

The app has been submitted and will likely pass App Review (Apple checks for crashes, not clinical rigor). However, the findings below represent real risks for clinical users, subscription revenue, and long-term maintenance. The S0 issue (fatalError) should be patched in the first post-approval update.

**Findings Summary:**

| Severity | Count |
|----------|-------|
| S0 — Ship Blocker | 1 |
| S1 — Must Fix Before Launch | 6 |
| S2 — Should Fix Soon | 11 |
| S3 — Nice to Have | 17 |
| S4 — Observation | 12 (7 positive) |

---

## PRD & Requirements Gaps

The iOS app has **no PRD of its own**. The only PRD found (`api-spec/PRD.md`) is for the Clinical Plan Generator API pipeline — a separate backend system. The iOS app was built without a formal requirements document.

| # | Gap | Severity | Impact | Recommendation |
|---|-----|----------|--------|----------------|
| R1 | No iOS app PRD exists | S2 | No documented requirements to test against; no success criteria defined | Create a lightweight PRD covering target users, core flows, accessibility requirements, and measurable success criteria |
| R2 | No accessibility requirements stated anywhere | S1 | Zero a11y support in the app; excludes visually impaired clinicians | Define WCAG AA target and add accessibility requirements to project docs |
| R3 | No offline behavior specification | S3 | App works offline by accident (bundled JSON) but this is undocumented | Document which features require network and what happens when offline |
| R4 | No data lifecycle policy | S3 | No specification for UserDefaults data growth, cleanup, or migration | Define retention policies for cached data, error reports, and feedback |
| R5 | No performance requirements | S3 | No defined launch time, memory budget, or data volume limits | Set targets: launch < 2s, memory < 100MB, plans.json < 20MB |
| R6 | No security requirements for entitlement system | S1 | Trial bypass via UserDefaults manipulation is trivial | Define server-side validation requirements for paid features |
| R7 | PRD for API pipeline references GPT-5.2 and OpenAI but code uses Claude Opus 4.5 | S4 | PRD contradicts itself (mentions GPT-5.2 in data flow, Claude Opus in model assignment) | Update PRD to reflect actual model choices consistently |

---

## Architecture & Code Findings

### Error Handling & Reliability

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A1 | **`fatalError()` in ReferenceStore** — 2 calls that will crash the app if bundled JSON files are missing or corrupted. No recovery path. | S0 | `ReferenceStore.swift:115,125` | Replace with graceful error handling: return empty arrays and show user-facing error alert |
| A2 | **Silent failure on plans.json load** — If the 10MB plans.json fails to decode, the app shows a blank screen with no error message | S1 | `PlanStore.swift:52-67` | Surface an error state in the UI; show a retry option or explain what happened |
| A3 | Fire-and-forget network calls with `try?` silently swallow errors for analytics, sign-out, and email recording | S2 | `EntitlementService.swift:249-255, 264, 308` | At minimum, log errors with os_log; consider structured error reporting |
| A4 | No structured logging framework — all logging is `print()` (5 occurrences), invisible in production | S2 | All `Services/` files | Adopt `os_log` or `Logger` for production-visible diagnostics |
| A5 | `verifyCode` conflates all OTP errors (network, expired, rate-limited, invalid) into `.invalidCode` | S2 | `EntitlementService.swift:238-239` | Differentiate error types so users see "Network error" vs "Invalid code" |

### Security & Data Protection

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A6 | **Supabase anon key hardcoded** — URL and JWT visible in source. Acceptable only if RLS policies are correct on all Supabase tables. | S1 | `SupabaseService.swift:9-10` | Verify RLS policies are enabled and correct on all tables (verified_emails, whitelisted_domains, etc.) |
| A7 | **Email addresses stored in plain UserDefaults** — unencrypted, extractable from device backups | S1 | `EntitlementService.swift:21` | Move to Keychain for storing verified email addresses |
| A8 | Clinical error reports stored in UserDefaults — free-text description field could contain PHI if clinician accidentally includes patient info | S2 | `ClinicalErrorService.swift:11-23` | Add PHI warning to the error report UI; consider Keychain or encrypted storage |
| A9 | No `PrivacyInfo.xcprivacy` file — Apple requires this manifest for apps using UserDefaults (covered by NSPrivacyAccessedAPICategoryUserDefaults) | S1 | Missing file | Create PrivacyInfo.xcprivacy declaring UserDefaults usage with appropriate reasons |

### Subscription & Entitlement Security

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A10 | **Trial start date in unprotected UserDefaults** — trivially reset by reinstalling app or modifying defaults | S1 | `EntitlementService.swift:13-16` | Move to Keychain; consider server-side trial tracking via Supabase |
| A11 | **"Free year" reward trivially manipulable** — `hasEarnedFreeYear` and `freeYearEarnedDate` in UserDefaults, no server verification | S1 | `ClinicalErrorService.swift:32-40`, `EntitlementService.swift:193-207` | Validate reward server-side; use Keychain for local storage |
| A12 | No server-side receipt validation — StoreKit 2 on-device verification only | S2 | `EntitlementService.swift:332-344` | Acceptable for $12.99/yr but implement server-side validation to detect refund abuse |
| A13 | `shouldCreateUser: true` on OTP creates orphaned Supabase Auth users for non-whitelisted attempts | S3 | `EntitlementService.swift:223-226` | Set to `false` or implement cleanup job for orphaned users |

### Performance & Memory

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A14 | **10.1 MB plans.json loaded entirely into memory on launch** — ~15-25MB total with decoded Swift objects | S1 | `plans.json` (10,565,434 bytes), `PlanStore.swift:59` | Implement lazy loading, split into per-category files, or use on-demand resources |
| A15 | Computed properties (`allPlans`, `allScales`, etc.) re-sort arrays on every SwiftUI render cycle access | S3 | `PlanStore.swift:19`, `ReferenceStore.swift:17-27` | Cache sorted results; invalidate only when source data changes |
| A16 | StopwatchService timer fires 100x/sec (0.01s interval), driving 100 `@Observable` diffs per second | S3 | `StopwatchService.swift:20` | Reduce to 10Hz (0.1s) — users cannot perceive 10ms precision; add `.common` run loop mode |

### State Management

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A17 | Unguarded Task spawning in `EntitlementService.init()` — races with app startup | S2 | `EntitlementService.swift:147-159` | Use `.task` modifier on root view instead of spawning from init |
| A18 | No scenePhase handling — entitlements not refreshed on foreground return; stopwatch not paused on background | S2 | `NeuroPlansApp.swift` (absent) | Add `@Environment(\.scenePhase)` to handle foreground/background transitions |
| A19 | No memory warning handling | S2 | (absent) | Implement `didReceiveMemoryWarning` to release non-visible plan data |
| A20 | No state restoration — Plan Builder selections, search text, selected tab lost on termination | S3 | (absent) | Persist Plan Builder state to UserDefaults or SwiftData |

### Accessibility

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A21 | **Zero accessibility labels, hints, or values in entire codebase** — 0 occurrences of `accessibilityLabel`, `accessibilityHint`, `accessibilityValue` | S1 | All `.swift` files | Add accessibility modifiers to all interactive elements, data displays, and navigation elements |

### Testing

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A22 | **Zero test targets, zero test files** — no unit tests, no UI tests, no snapshot tests | S2 | `project.pbxproj` | Add test targets; prioritize testing EntitlementService, PlanStore data loading, and CalculatorEngine accuracy |

### Network

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A23 | No retry logic on any network call | S2 | All Services with network calls | Add exponential backoff retry for transient failures |
| A24 | No timeout configuration — default 60s URLSession timeout | S2 | `SupabaseService.swift` | Configure reasonable timeouts (10-15s) with user feedback during wait |

### Other Code Quality

| # | Finding | Severity | File(s) | Recommendation |
|---|---------|----------|---------|----------------|
| A25 | Hardcoded version "1.0.0" instead of reading from bundle | S3 | `SettingsView.swift:119` | Use `Bundle.main.infoDictionary?["CFBundleShortVersionString"]` |
| A26 | Hardcoded data version "Feb 2026" will go stale | S3 | `SettingsView.swift:127` | Derive from plans.json metadata or build date |
| A27 | Feedback text accumulates in UserDefaults with no limit | S3 | `SettingsView.swift:148-153` | Add max entries; implement send/clear mechanism |
| A28 | Email validation only checks `contains("@") && contains(".")` — accepts `@.` | S3 | `EmailVerificationView.swift:361-364` | Use proper regex or `NSDataDetector` for email validation |
| A29 | Calculator inputs have no upper bounds — weight=99999 produces absurd clinical results | S3 | `CalculatorEngine.swift` | Add clinical range warnings for out-of-bounds inputs |
| A30 | Timer leak potential in EmailVerificationView cooldown | S3 | `EmailVerificationView.swift:424-432` | Invalidate timer on view disappear |

### Positive Findings

| # | Finding | Severity |
|---|---------|----------|
| A31 | No PHI stored or transmitted by design — app is a reference tool, not a patient data tool | S4 (positive) |
| A32 | Single reputable dependency (Supabase Swift SDK v2.41.1) — minimal supply chain risk | S4 (positive) |
| A33 | OTP input correctly filtered to digits with 6-char limit | S4 (positive) |
| A34 | Search uses in-memory string matching — no SQL injection risk | S4 (positive) |
| A35 | Uses SF Symbols exclusively — no bitmap image memory issues | S4 (positive) |
| A36 | No TODO/FIXME/HACK comments in codebase | S4 (positive) |
| A37 | Disclaimer acceptance properly persisted via @AppStorage | S4 (positive) |

---

## Live Product Findings

| # | Finding | Phase | Severity | Details | Recommendation |
|---|---------|-------|----------|---------|----------------|
| L1 | App launches cleanly, no crashes | Happy Path | S4 (positive) | 0.209s simctl launch time; zero crash logs; zero runtime errors | N/A |
| L2 | Dark mode renders correctly | Cross-Platform | S4 (positive) | All colors adapt properly; badges remain readable; no contrast issues | N/A |
| L3 | Dynamic Type (XL) scales properly | Accessibility | S4 (positive) | Text, badges, and headers all adapt proportionally | N/A |
| L4 | Dynamic Type (AXXXL) pushes all content below fold | Accessibility | S3 | At extreme accessibility sizes, only title/description visible — no clinical steps above the fold | Consider condensed header mode at extreme sizes |
| L5 | App data footprint is 580KB | Performance | S4 (positive) | Very lightweight; no unnecessary data accumulation | N/A |
| L6 | Zero Auto Layout constraint warnings | UX | S4 (positive) | Clean layout system with no broken or ambiguous constraints | N/A |
| L7 | App binary ~11MB estimated release size (10MB is plans.json) | Performance | S3 | plans.json dominates binary size; will grow with content | Monitor; consider on-demand resources if exceeding 20MB |
| L8 | VoiceOver audit not possible via simctl | Accessibility | S2 | `xcrun simctl accessibility` not available; manual Accessibility Inspector audit needed | Run Accessibility Inspector audit before next update |

---

## Competitive Assessment

| Area | Neuro Plans | Industry Standard | Gap |
|------|-------------|-------------------|-----|
| **Content depth** | ~90 neurology conditions, structured treatment plans | UpToDate: 12,800+ topics; MDCalc: 900+ calculators | Intentionally narrow, but very thin vs. established players |
| **Pricing** | $12.99/year | MDCalc/Medscape/NeuroLogicMD: Free; UpToDate: ~$530/yr | Awkward middle: more than free alternatives, far less than premium tools |
| **Evidence citations** | AI-generated, multi-model verified | Physician-authored, peer-reviewed, GRADE-rated | Credibility gap — AI-generated content is an unproven trust model in clinical decision support |
| **Offline access** | Full (bundled JSON) | MDCalc: Yes; UpToDate: Partial | Competitive strength |
| **Clinical calculators** | NIHSS, GCS, select neurology scales | MDCalc: 900+ (free, 4.9 stars, 51K ratings) | Severely outmatched in quantity and quality |
| **Drug interactions** | None | Epocrates, Medscape, DynaMed: Full interaction checkers | **Critical missing feature** — table-stakes for any app listing medications |
| **CME credits** | None | Medscape: Free CME/MOC; Epocrates: Free CME; MDCalc: CME tracking | Completely missing — major engagement and retention gap |
| **Evidence grading** | None | UpToDate: GRADE system; AAN: Class I-IV | Recommendations lack quality-of-evidence context |
| **Editorial transparency** | AI-generated, physician-reviewed (process undisclosed) | UpToDate: Named authors, review dates per topic | Who authored each plan? When was it last reviewed? |
| **Update frequency** | Manual AI pipeline, monthly freshness checks | UpToDate: Continuous; DynaMed: Daily | Adequate for v1 but needs to scale |
| **Unique features** | Venue-specific treatment tables (ED/Hospital/Outpatient/ICU), Plan Builder | No direct equivalent in competitors | **Genuine differentiator** — no competitor structures care by clinical venue |

### Direct Competitor Threat: NeuroLogicMD (Free)
A brand-new free app covering the same niche: interactive clinical pathways for stroke/seizure/headache/dizziness, NIHSS/GCS/mRS calculators, physical exam tools, and board review questions. It also includes encryption and offline support. Zero ratings currently, but it directly overlaps with Neuro Plans' core value proposition at no cost.

---

## Prioritized Action Plan

### Immediate (S0 — Ship Blockers)
1. **Replace `fatalError()` with graceful error handling** in `ReferenceStore.swift:115,125` — return empty arrays and show user-facing error state

### Before Next Update (S1 — Must Fix)
1. **Create `PrivacyInfo.xcprivacy`** declaring UserDefaults API usage — Apple may reject future updates without this
2. **Move trial/entitlement data to Keychain** — `trialStartDate`, `verifiedEmail`, `hasEarnedFreeYear`, `freeYearEarnedDate` (`EntitlementService.swift`, `ClinicalErrorService.swift`)
3. **Add accessibility labels** to all interactive elements — start with navigation, tab bar, plan list items, calculator inputs, and buttons
4. **Add error UI for plans.json load failure** — `PlanStore.swift:52-67`
5. **Verify Supabase RLS policies** are enabled and correct on all tables
6. **Address plans.json memory footprint** — consider lazy loading or splitting the 10.1MB file

### Soon (S2 — Fix in Next Sprint)
1. Add `@Environment(\.scenePhase)` handling for foreground/background transitions
2. Add structured logging (`os_log` or `Logger`)
3. Create test targets — start with `EntitlementService`, `PlanStore`, `CalculatorEngine`
4. Add network retry logic and timeout configuration
5. Handle memory warnings
6. Differentiate OTP error types
7. Run Accessibility Inspector audit
8. Create iOS app PRD

### Backlog (S3-S4)
1. Cache sorted computed properties for performance
2. Reduce StopwatchService timer frequency to 10Hz
3. Persist Plan Builder state for crash recovery
4. Add calculator input range warnings
5. Read version from bundle instead of hardcoding
6. Add drug interaction checking (competitive necessity)
7. Investigate CME credit partnership opportunities
8. Add evidence grading to treatment plans

---

## What's Working Well

1. **Clean architecture** — Single-responsibility services with `@Observable` pattern, one dependency (Supabase), SF Symbols throughout. A new developer could understand this codebase in under an hour.

2. **Venue-specific treatment plans** — The ED/Hospital/Outpatient/ICU column format is genuinely unique. No competitor structures neurology care this way. This is the product's strongest differentiator.

3. **Visual polish** — Dark mode works perfectly, Dynamic Type scales properly at normal sizes, zero Auto Layout warnings, consistent design language throughout.

4. **Offline-first by design** — All clinical content is bundled locally. The app works completely without network for its core use case. Only subscription/verification features need connectivity.

5. **Privacy-conscious** — No PHI collected, no analytics tracking, minimal data sent to Supabase (only verified emails and error reports). The app collects less data than virtually any competitor.

---

## Test Environment

- **Simulator:** iPhone 17 Pro Max (iOS 26.2), UDID: DA33D2DA-72AE-4907-A226-22B09B425A8C
- **Xcode:** 26.3 (Build 17C519)
- **Network:** Online (simulator, localhost network)
- **Tools Used:** Claude Code (terminal analysis), xcrun simctl (screenshots, UI testing), grep/find (code analysis), web search (competitive research)
- **Duration:** ~90 minutes total across Phases 0-4
- **App Version:** 1.0.0 (Build 1) — currently "Waiting for Review" in App Store Connect

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinical Plan Builder | Neuro Plans</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --stat: #dc2626;
      --stat-bg: #fee2e2;
      --urgent: #ea580c;
      --urgent-bg: #ffedd5;
      --routine: #2563eb;
      --routine-bg: #dbeafe;
      --ext: #7c3aed;
      --ext-bg: #f3e8ff;
      --border: #e5e7eb;
      --text: #1f2937;
      --text-light: #6b7280;
      --bg: #ffffff;
      --bg-secondary: #f9fafb;
      --custom-bg: #fef3c7;
      --custom-border: #fcd34d;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      line-height: 1.5;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    .back-btn {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .back-btn:hover { background: var(--primary-dark); }

    /* Controls */
    .controls {
      background: var(--bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: end; }
    .control-group { flex: 1; min-width: 200px; }
    .control-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem; }
    .control-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--bg);
    }
    .venue-tabs { display: flex; gap: 8px; }
    .venue-tab {
      padding: 10px 20px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      font-weight: 500;
      cursor: pointer;
    }
    .venue-tab:hover { border-color: var(--primary); }
    .venue-tab.active { background: var(--primary); border-color: var(--primary); color: white; }

    /* Main Layout */
    .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }

    /* Plan Content */
    .plan-content {
      background: var(--bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Section */
    .section { margin-bottom: 28px; }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    .section-title { font-size: 1.1rem; font-weight: 600; }

    /* Subsection */
    .subsection { margin-bottom: 16px; }
    .subsection-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    /* Items */
    .item-list { display: flex; flex-direction: column; gap: 8px; }
    .item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    .item:hover { background: #f0f0f5; }
    .item.selected { background: #e0e7ff; border-color: #a5b4fc; }
    .item.custom { background: var(--custom-bg); border-color: var(--custom-border); }
    .item.custom.selected { background: #fde68a; border-color: #f59e0b; }
    .item-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; flex-shrink: 0; }
    .item-name { flex: 1; font-size: 0.9rem; font-weight: 500; }

    /* Item Details */
    .item-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-left: 26px;
      font-size: 0.8rem;
      color: var(--text-light);
    }
    .item-detail {
      display: flex;
      gap: 6px;
    }
    .item-detail-label {
      font-weight: 600;
      color: var(--text);
      min-width: 90px;
      flex-shrink: 0;
    }
    .item-detail-value {
      flex: 1;
    }
    .item-dosing {
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .item-contraindication {
      color: #dc2626;
      font-weight: 500;
    }

    /* Priority badges */
    .priority {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.65rem;
      text-transform: uppercase;
      margin-right: 6px;
    }
    .priority-stat { background: var(--stat-bg); color: var(--stat); }
    .priority-urgent { background: var(--urgent-bg); color: var(--urgent); }
    .priority-routine { background: var(--routine-bg); color: var(--routine); }
    .priority-ext { background: var(--ext-bg); color: var(--ext); }

    /* Add Item Input - Always visible under each section */
    .add-item-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding: 8px;
      background: #fffbeb;
      border: 1px dashed var(--custom-border);
      border-radius: 6px;
    }
    .add-item-input input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .add-item-input input:focus { outline: none; border-color: var(--primary); }
    .add-item-input input::placeholder { color: #9ca3af; }

    /* Sidebar */
    .sidebar { position: sticky; top: 80px; height: fit-content; }
    .sidebar-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 12px;
    }
    .sidebar-title {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .selected-count {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    /* Selected Items - Clean list, just names, click to edit */
    .selected-list { max-height: 350px; overflow-y: auto; }
    .selected-section { margin-bottom: 12px; }
    .selected-section:last-child { margin-bottom: 0; }
    .selected-section-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }
    .selected-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }
    .selected-item.custom { background: var(--custom-bg); }
    .selected-item-text {
      flex: 1;
      cursor: text;
      padding: 4px 6px;
      border-radius: 4px;
      min-height: 20px;
      line-height: 1.4;
      word-break: break-word;
    }
    .selected-item-text:hover { background: rgba(79, 70, 229, 0.1); }
    .selected-item-text:focus {
      outline: none;
      background: white;
      box-shadow: 0 0 0 2px var(--primary);
    }
    .selected-item-dosing {
      color: #1e40af;
      font-weight: 500;
    }
    .selected-item-remove {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      font-size: 1rem;
      padding: 0 4px;
      opacity: 0.5;
    }
    .selected-item-remove:hover { opacity: 1; color: var(--stat); }

    /* Notes */
    .notes-textarea {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
    }
    .notes-textarea:focus { outline: none; border-color: var(--primary); }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      font-size: 0.9rem;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }

    /* References Section - Collapsible */
    .references-section {
      margin-top: 32px;
      border-top: 2px solid var(--border);
      padding-top: 20px;
    }
    .collapsible {
      margin-bottom: 8px;
    }
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .collapsible-header:hover { background: #e5e7eb; }
    .collapsible-icon { transition: transform 0.2s; }
    .collapsible.open .collapsible-icon { transform: rotate(180deg); }
    .collapsible-content {
      display: none;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 0 0 8px 8px;
      margin-top: -8px;
      padding-top: 24px;
    }
    .collapsible.open .collapsible-content { display: block; }

    /* Reference Content Styling */
    .ref-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .ref-item:last-child { border-bottom: none; }
    .ref-term { font-weight: 600; color: var(--primary); }
    .ref-definition { color: var(--text); margin-left: 8px; }

    /* Differential Table */
    .diff-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 8px;
    }
    .diff-table th, .diff-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .diff-table th { background: var(--bg); font-weight: 600; }

    /* Evidence Table */
    .evidence-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 8px;
    }
    .evidence-table th, .evidence-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .evidence-table th { background: var(--bg); font-weight: 600; }
    .evidence-level {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      background: #dbeafe;
      color: #1e40af;
    }

    /* Notes List */
    .notes-list { list-style: none; }
    .notes-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      position: relative;
      padding-left: 16px;
    }
    .notes-list li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--primary);
      font-weight: bold;
    }
    .notes-list li:last-child { border-bottom: none; }

    /* Appendix Content */
    .appendix-content {
      background: white;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      margin-top: 8px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e293b;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state h3 { margin-bottom: 8px; color: var(--text); }

    /* Priority Legend */
    .priority-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
      font-size: 0.75rem;
      margin-top: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; }
  </style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <div class="header-left">
      <a href="../" class="back-btn">← Home</a>
      <span class="logo">Clinical Plan Builder</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="controls">
    <div class="controls-row">
      <div class="control-group">
        <label for="diagnosis-select">Diagnosis</label>
        <select id="diagnosis-select">
          <option value="">Select a diagnosis...</option>
        </select>
      </div>
      <div class="control-group">
        <label>Care Setting</label>
        <div class="venue-tabs" id="venue-tabs">
          <button class="venue-tab" data-venue="ED">ED</button>
          <button class="venue-tab" data-venue="HOSP">Hospital</button>
          <button class="venue-tab" data-venue="OPD">Outpatient</button>
          <button class="venue-tab" data-venue="ICU">ICU</button>
        </div>
      </div>
    </div>
    <div class="priority-legend">
      <div class="legend-item"><span class="priority priority-stat">STAT</span> Immediate</div>
      <div class="legend-item"><span class="priority priority-urgent">URGENT</span> Within hours</div>
      <div class="legend-item"><span class="priority priority-routine">ROUTINE</span> Standard</div>
      <div class="legend-item"><span class="priority priority-ext">EXT</span> Extended</div>
    </div>
  </div>

  <div class="main-layout">
    <div class="plan-content" id="plan-content">
      <div class="empty-state">
        <h3>Select a Diagnosis</h3>
        <p>Choose a diagnosis and care setting to view the clinical plan.</p>
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-card">
        <div class="sidebar-title">
          Selected Items
          <span class="selected-count" id="selected-count">0</span>
        </div>
        <div class="selected-list" id="selected-list">
          <p style="color: var(--text-light); font-size: 0.85rem;">No items selected</p>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="sidebar-title">Additional Notes</div>
        <textarea class="notes-textarea" id="notes" placeholder="Add notes..."></textarea>
      </div>

      <button class="btn btn-primary" id="copy-btn" style="margin-bottom: 8px;">Copy to Clipboard</button>
      <button class="btn btn-secondary" id="clear-btn">Clear Selection</button>
    </div>
  </div>
</div>

<script>
  let plansData = {};
  let currentDiagnosis = null;
  let currentVenue = null;
  let selectedItems = new Map();
  let customItems = new Map();

  const diagnosisSelect = document.getElementById('diagnosis-select');
  const venueTabs = document.getElementById('venue-tabs');
  const planContent = document.getElementById('plan-content');
  const selectedList = document.getElementById('selected-list');
  const selectedCount = document.getElementById('selected-count');
  const notesTextarea = document.getElementById('notes');
  const copyBtn = document.getElementById('copy-btn');
  const clearBtn = document.getElementById('clear-btn');

  async function loadPlans() {
    try {
      const response = await fetch('../data/plans.json');
      plansData = await response.json();
      Object.keys(plansData).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        diagnosisSelect.appendChild(opt);
      });
    } catch (e) {
      planContent.innerHTML = '<div class="empty-state"><h3>Unable to Load Plans</h3></div>';
    }
  }

  diagnosisSelect.addEventListener('change', e => {
    currentDiagnosis = e.target.value;
    selectedItems.clear();
    customItems.clear();
    updateSelectedList();
    if (currentDiagnosis && currentVenue) renderPlan();
  });

  venueTabs.addEventListener('click', e => {
    if (e.target.classList.contains('venue-tab')) {
      venueTabs.querySelectorAll('.venue-tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      currentVenue = e.target.dataset.venue;
      if (currentDiagnosis && currentVenue) renderPlan();
    }
  });

  function getPriorityClass(p) {
    if (!p || p === '-') return null;
    const pl = p.toLowerCase();
    if (pl === 'stat') return 'priority-stat';
    if (pl === 'urgent') return 'priority-urgent';
    if (pl === 'routine') return 'priority-routine';
    if (pl === 'ext') return 'priority-ext';
    return null;
  }

  function renderPlan() {
    const plan = plansData[currentDiagnosis];
    if (!plan || !plan.sections) {
      planContent.innerHTML = '<div class="empty-state"><h3>No data available</h3></div>';
      return;
    }

    let html = '';

    // Sections
    for (const [sectionName, subsections] of Object.entries(plan.sections)) {
      let sectionHasItems = false;
      let sectionHtml = `<div class="section" data-section="${sectionName}">
        <div class="section-header"><h2 class="section-title">${sectionName}</h2></div>`;

      for (const [subsectionName, items] of Object.entries(subsections)) {
        const filtered = items.filter(item => {
          const p = item[currentVenue];
          return p && p !== '-';
        });
        if (!filtered.length) continue;
        sectionHasItems = true;

        sectionHtml += `<div class="subsection"><div class="subsection-title">${subsectionName}</div><div class="item-list">`;
        filtered.forEach((item, idx) => {
          const itemId = `${sectionName}__${subsectionName}__${idx}`;
          const priority = item[currentVenue];
          const pc = getPriorityClass(priority);
          const sel = selectedItems.has(itemId);
          const name = item.item || item.name || item.treatment || 'Item';

          // Build details HTML
          let detailsHtml = '';
          if (item.dosing) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">Dosing:</span><span class="item-detail-value item-dosing">${item.dosing}</span></div>`;
          }
          if (item.rationale) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">Rationale:</span><span class="item-detail-value">${item.rationale}</span></div>`;
          }
          if (item.timing) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">Timing:</span><span class="item-detail-value">${item.timing}</span></div>`;
          }
          if (item.target) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">Target:</span><span class="item-detail-value">${item.target}</span></div>`;
          }
          if (item.contraindications) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">⚠️ Avoid:</span><span class="item-detail-value item-contraindication">${item.contraindications}</span></div>`;
          }
          if (item.monitoring) {
            detailsHtml += `<div class="item-detail"><span class="item-detail-label">Monitor:</span><span class="item-detail-value">${item.monitoring}</span></div>`;
          }

          sectionHtml += `<div class="item ${sel ? 'selected' : ''}" data-id="${itemId}" data-section="${sectionName}" data-subsection="${subsectionName}">
            <div class="item-header">
              <input type="checkbox" ${sel ? 'checked' : ''}>
              <div class="item-name">${pc ? `<span class="priority ${pc}">${priority}</span>` : ''}${name}</div>
            </div>
            ${detailsHtml ? `<div class="item-details">${detailsHtml}</div>` : ''}
          </div>`;
        });
        sectionHtml += '</div></div>';
      }

      // Custom items for this section
      const sectionCustom = [...customItems.entries()].filter(([id, item]) => item.section === sectionName);
      if (sectionCustom.length) {
        sectionHtml += `<div class="subsection"><div class="subsection-title">Custom Items</div><div class="item-list">`;
        sectionCustom.forEach(([cid, citem]) => {
          const sel = selectedItems.has(cid);
          sectionHtml += `<div class="item custom ${sel ? 'selected' : ''}" data-id="${cid}" data-section="${sectionName}" data-custom="true">
            <div class="item-header">
              <input type="checkbox" ${sel ? 'checked' : ''}>
              <div class="item-name">${citem.name}</div>
            </div>
          </div>`;
        });
        sectionHtml += '</div></div>';
      }

      // Add item input - always visible
      sectionHtml += `<div class="add-item-input">
        <input type="text" placeholder="Add custom item to ${sectionName}..." data-section="${sectionName}" class="custom-input">
      </div>`;

      sectionHtml += '</div>';
      if (sectionHasItems || sectionCustom.length) html += sectionHtml;
    }

    // References Section
    html += `<div class="references-section">`;

    // Definitions
    if (plan.definitions && plan.definitions.length) {
      html += `<div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>Definitions</span><span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content">`;
      plan.definitions.forEach(d => {
        html += `<div class="ref-item"><span class="ref-term">${d.term}:</span><span class="ref-definition">${d.definition}</span></div>`;
      });
      html += `</div></div>`;
    }

    // Differential
    if (plan.differential && plan.differential.length) {
      html += `<div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>Differential Diagnosis</span><span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content">
          <table class="diff-table">
            <tr><th>Diagnosis</th><th>Features</th><th>Tests</th></tr>`;
      plan.differential.forEach(d => {
        html += `<tr><td><strong>${d.diagnosis}</strong></td><td>${d.features}</td><td>${d.tests}</td></tr>`;
      });
      html += `</table></div></div>`;
    }

    // Notes
    if (plan.notes && plan.notes.length) {
      html += `<div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>Clinical Notes</span><span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content"><ul class="notes-list">`;
      plan.notes.forEach(n => {
        html += `<li>${n}</li>`;
      });
      html += `</ul></div></div>`;
    }

    // Evidence
    if (plan.evidence && plan.evidence.length) {
      html += `<div class="collapsible">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>Evidence & References</span><span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content">
          <table class="evidence-table">
            <tr><th>Recommendation</th><th>Level</th><th>Source</th></tr>`;
      plan.evidence.forEach(e => {
        html += `<tr><td>${e.recommendation}</td><td><span class="evidence-level">${e.level}</span></td><td>${e.source}</td></tr>`;
      });
      html += `</table></div></div>`;
    }

    // Appendices
    if (plan.appendices && plan.appendices.length) {
      plan.appendices.forEach(app => {
        html += `<div class="collapsible">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span>${app.title}</span><span class="collapsible-icon">▼</span>
          </div>
          <div class="collapsible-content">
            <div class="appendix-content">${app.content}</div>
          </div>
        </div>`;
      });
    }

    html += `</div>`;

    planContent.innerHTML = html || '<div class="empty-state"><h3>No items for this venue</h3></div>';

    // Attach item click handlers
    planContent.querySelectorAll('.item').forEach(item => {
      item.addEventListener('click', e => {
        // Allow clicking anywhere on the item to toggle, except directly on checkbox
        if (e.target.tagName === 'INPUT') return;
        toggleItem(item);
      });
      const checkbox = item.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.addEventListener('change', () => toggleItem(item));
      }
    });

    // Attach custom input handlers - press Enter to add
    planContent.querySelectorAll('.custom-input').forEach(input => {
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && input.value.trim()) {
          const section = input.dataset.section;
          const name = input.value.trim();
          const cid = `custom__${section}__${Date.now()}`;
          const citem = { name, section, isCustom: true };
          customItems.set(cid, citem);
          selectedItems.set(cid, { ...citem, editedName: name });
          input.value = '';
          renderPlan();
          updateSelectedList();
          showToast('Item added');
        }
      });
    });
  }

  window.toggleCollapsible = function(header) {
    header.parentElement.classList.toggle('open');
  };

  function toggleItem(itemEl) {
    const id = itemEl.dataset.id;
    const cb = itemEl.querySelector('input[type="checkbox"]');
    const section = itemEl.dataset.section;
    const subsection = itemEl.dataset.subsection || '';
    const isCustom = itemEl.dataset.custom === 'true';

    if (selectedItems.has(id)) {
      selectedItems.delete(id);
      itemEl.classList.remove('selected');
      cb.checked = false;
    } else {
      let itemData;
      if (isCustom) {
        itemData = customItems.get(id);
      } else {
        const plan = plansData[currentDiagnosis];
        const items = plan.sections[section]?.[subsection] || [];
        const idx = parseInt(id.split('__').pop());
        itemData = items[idx];
      }
      if (itemData) {
        const name = itemData.item || itemData.name || itemData.treatment || 'Item';
        // Include dosing in the display name for medications
        const displayName = itemData.dosing ? `${name} — ${itemData.dosing}` : name;
        selectedItems.set(id, { ...itemData, section, subsection, isCustom, editedName: displayName, originalName: name });
      }
      itemEl.classList.add('selected');
      cb.checked = true;
    }
    updateSelectedList();
  }

  function updateSelectedList() {
    selectedCount.textContent = selectedItems.size;
    if (!selectedItems.size) {
      selectedList.innerHTML = '<p style="color: var(--text-light); font-size: 0.85rem;">No items selected</p>';
      return;
    }

    const grouped = {};
    selectedItems.forEach((item, id) => {
      const sec = item.section || 'Other';
      if (!grouped[sec]) grouped[sec] = [];
      grouped[sec].push({ id, ...item });
    });

    let html = '';
    for (const [sec, items] of Object.entries(grouped)) {
      html += `<div class="selected-section"><div class="selected-section-label">${sec}</div>`;
      items.forEach(item => {
        html += `<div class="selected-item ${item.isCustom ? 'custom' : ''}" data-id="${item.id}">
          <span class="selected-item-text" contenteditable="true" data-id="${item.id}">${item.editedName}</span>
          <button class="selected-item-remove" data-id="${item.id}">×</button>
        </div>`;
      });
      html += '</div>';
    }
    selectedList.innerHTML = html;

    // Attach remove handlers
    selectedList.querySelectorAll('.selected-item-remove').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = btn.dataset.id;
        selectedItems.delete(id);
        const itemEl = planContent.querySelector(`.item[data-id="${id}"]`);
        if (itemEl) {
          itemEl.classList.remove('selected');
          itemEl.querySelector('input[type="checkbox"]').checked = false;
        }
        updateSelectedList();
      });
    });

    // Attach inline edit handlers - click directly to edit
    selectedList.querySelectorAll('.selected-item-text').forEach(span => {
      span.addEventListener('blur', () => {
        const id = span.dataset.id;
        const item = selectedItems.get(id);
        if (item) {
          item.editedName = span.textContent.trim() || item.editedName;
          selectedItems.set(id, item);
        }
      });
      span.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          span.blur();
        }
      });
    });
  }

  function generateOutput() {
    if (!selectedItems.size) return '';
    let out = `CLINICAL PLAN: ${currentDiagnosis}\nSetting: ${currentVenue}\nGenerated: ${new Date().toLocaleString()}\n${'─'.repeat(50)}\n\n`;

    const grouped = {};
    selectedItems.forEach((item, id) => {
      const sec = item.section || 'Other';
      if (!grouped[sec]) grouped[sec] = [];
      grouped[sec].push(item);
    });

    for (const [sec, items] of Object.entries(grouped)) {
      out += `## ${sec}\n`;
      items.forEach(item => {
        const name = item.editedName || 'Item';
        const priority = item[currentVenue] || '';
        out += priority ? `• [${priority}] ${name}\n` : `• ${name}\n`;
      });
      out += '\n';
    }

    const notes = notesTextarea.value.trim();
    if (notes) out += `## Additional Notes\n${notes}\n`;
    return out;
  }

  copyBtn.addEventListener('click', () => {
    const out = generateOutput();
    if (!out) { showToast('No items selected'); return; }
    navigator.clipboard.writeText(out).then(() => showToast('Copied!')).catch(() => showToast('Failed'));
  });

  clearBtn.addEventListener('click', () => {
    selectedItems.clear();
    customItems.clear();
    notesTextarea.value = '';
    renderPlan();
    updateSelectedList();
  });

  function showToast(msg) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  loadPlans();
</script>

</body>
</html>
